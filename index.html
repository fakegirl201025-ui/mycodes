<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Store BD</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #0a84ff;
            --primary-dark: #0066cc;
            --secondary: #ff375f;
            --accent: #32d74b;
            --danger: #ff453a;
            --warning: #ffd60a;
            --dark-bg: #121212;
            --dark-card: #1c1c1e;
            --darker-card: #171717;
            --text: #ffffff;
            --text-secondary: #8e8e93;
            --border: #2c2c2e;
            --success: #30d158;
            --pending: #ff9f0a;
            --gradient: linear-gradient(135deg, #0a84ff 0%, #5e5ce6 100%);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            --glow: 0 0 20px rgba(10, 132, 255, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background-color: var(--dark-bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        .loading-logo {
            font-size: 3.5rem;
            font-weight: 800;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 1.5rem;
            letter-spacing: 1px;
            text-shadow: var(--glow);
            animation: pulse 2s infinite;
        }
        
        .loading-bar {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .loading-progress {
            position: absolute;
            height: 100%;
            width: 0%;
            background: var(--gradient);
            border-radius: 10px;
            animation: loading 3s ease-in-out forwards;
        }
        
        @keyframes loading {
            0% { width: 0%; }
            20% { width: 25%; }
            40% { width: 50%; }
            60% { width: 75%; }
            80% { width: 90%; }
            100% { width: 100%; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        
        /* Main App Container */
        .app-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2rem 1.5rem;
            background: rgba(28, 28, 30, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .logo span {
            color: var(--accent);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .user-avatar:hover {
            transform: scale(1.05);
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(20px);
            padding: 0.8rem 0;
            border-top: 1px solid var(--border);
            z-index: 99;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-icon {
            font-size: 1.3rem;
            margin-bottom: 0.3rem;
        }
        
        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--secondary);
            color: white;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Main Content */
        .main-content {
            padding: 1.5rem;
            padding-bottom: 80px; /* For bottom nav */
        }
        
        .page-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .page-title i {
            margin-right: 10px;
            color: var(--primary);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: var(--dark-card);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 1.5rem;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .tab.active {
            background: var(--gradient);
        }
        
        /* File Cards Grid */
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .file-card {
            background: var(--dark-card);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            animation: cardAppear 0.5s ease backwards;
        }
        
        .file-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: var(--glow);
        }
        
        @keyframes cardAppear {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .file-banner {
            height: 150px;
            width: 100%;
            background: var(--darker-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--primary);
            background-size: cover;
            background-position: center;
        }
        
        .file-content {
            padding: 1.2rem;
        }
        
        .file-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .file-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.4;
        }
        
        .file-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .file-price {
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .price-free {
            color: var(--accent);
        }
        
        .price-paid {
            color: var(--secondary);
        }
        
        .btn-get {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-get:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(10, 132, 255, 0.4);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal {
            background: var(--dark-card);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            overflow: hidden;
            animation: modalAppear 0.4s ease;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(30px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .modal-close:hover {
            color: var(--text);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 1.2rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .form-input {
            width: 100%;
            padding: 0.9rem;
            background: var(--darker-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.2);
        }
        
        .btn {
            padding: 0.9rem 1.8rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: var(--gradient);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(10, 132, 255, 0.3);
        }
        
        .btn-secondary {
            background: var(--dark-card);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        /* Payment Modal Specific */
        .payment-details {
            background: var(--darker-card);
            border-radius: 12px;
            padding: 1.2rem;
            margin-bottom: 1.5rem;
        }
        
        .payment-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
        }
        
        .payment-item:last-child {
            margin-bottom: 0;
        }
        
        .payment-label {
            color: var(--text-secondary);
        }
        
        .payment-value {
            font-weight: 600;
        }
        
        .bkash-number {
            background: var(--dark-card);
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .bkash-number span {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .btn-copy {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Vault Notifications */
        .vault-container {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }
        
        .notification-card {
            background: var(--dark-card);
            border-radius: 16px;
            padding: 1.5rem;
            border-left: 6px solid var(--border);
            transition: all 0.3s ease;
            animation: cardAppear 0.5s ease backwards;
        }
        
        .notification-card.pending {
            border-left-color: var(--pending);
        }
        
        .notification-card.approved {
            border-left-color: var(--success);
        }
        
        .notification-card.rejected {
            border-left-color: var(--danger);
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .notification-status {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .notification-time {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .notification-message {
            margin-bottom: 1.2rem;
            line-height: 1.5;
        }
        
        .notification-file {
            background: var(--darker-card);
            border-radius: 12px;
            padding: 1.2rem;
            margin-bottom: 1.2rem;
        }
        
        .file-preview {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .file-preview-img {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: var(--dark-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .file-preview-info h4 {
            margin-bottom: 0.3rem;
        }
        
        .file-preview-info p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Profile Page */
        .profile-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }
        
        .profile-name {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .profile-email {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            width: 100%;
            max-width: 500px;
            margin-bottom: 2.5rem;
        }
        
        .stat-card {
            background: var(--dark-card);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Login/Register Forms */
        .auth-tabs {
            display: flex;
            margin-bottom: 1.5rem;
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 1rem;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .auth-tab.active {
            border-bottom-color: var(--primary);
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.5;
        }
        
        /* Forced Login Overlay */
        .forced-login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            text-align: center;
            padding: 2rem;
        }
        
        .forced-login-message {
            max-width: 500px;
            margin-bottom: 2rem;
        }
        
        .forced-login-message h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .forced-login-message p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .files-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .header {
                padding: 1rem;
            }
            
            .main-content {
                padding: 1rem;
                padding-bottom: 80px;
            }
        }
        
        @media (max-width: 480px) {
            .files-grid {
                grid-template-columns: 1fr;
            }
            
            .modal {
                width: 95%;
            }
            
            .profile-stats {
                grid-template-columns: 1fr;
            }
        }
        
        /* Desktop Specific */
        @media (min-width: 1024px) {
            .bottom-nav {
                position: static;
                width: auto;
                flex-direction: column;
                background: transparent;
                border: none;
                padding: 0;
                gap: 2rem;
                margin-top: 2rem;
            }
            
            .app-container {
                display: grid;
                grid-template-columns: 250px 1fr;
                grid-template-rows: auto 1fr;
                grid-template-areas: 
                    "header header"
                    "sidebar main";
                height: 100vh;
            }
            
            .header {
                grid-area: header;
            }
            
            .sidebar {
                grid-area: sidebar;
                background: var(--dark-card);
                border-right: 1px solid var(--border);
                padding: 1.5rem;
                overflow-y: auto;
            }
            
            .main-content {
                grid-area: main;
                overflow-y: auto;
                padding: 2rem;
                padding-bottom: 2rem;
            }
            
            .nav-item {
                flex-direction: row;
                justify-content: flex-start;
                gap: 1rem;
                padding: 1rem;
                border-radius: 12px;
                margin-bottom: 0.5rem;
                font-size: 1rem;
            }
            
            .nav-item:hover {
                background: var(--darker-card);
            }
            
            .nav-item.active {
                background: var(--gradient);
                color: white;
            }
            
            .nav-icon {
                margin-bottom: 0;
                font-size: 1.2rem;
            }
            
            .badge {
                top: 5px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-logo">Code Store BD</div>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
    </div>
    
    <!-- Forced Login Overlay (Will show if user tries to access without login) -->
    <div id="forcedLoginOverlay" class="forced-login-overlay" style="display: none;">
        <div class="forced-login-message">
            <h2><i class="fas fa-lock"></i> Login Required</h2>
            <p>You must be logged in to access this feature. Please login or register to continue.</p>
            <button class="btn btn-primary" id="showLoginFromForced">
                <i class="fas fa-sign-in-alt"></i> Login / Register
            </button>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">Code<span>Store</span> BD</div>
            <div class="user-avatar" id="userAvatar">?</div>
        </header>
        
        <!-- Desktop Sidebar / Mobile Bottom Navigation -->
        <div class="sidebar">
            <nav class="bottom-nav" id="bottomNav">
                <a href="#" class="nav-item active" data-page="home">
                    <i class="fas fa-home nav-icon"></i>
                    <span>Home</span>
                </a>
                <a href="#" class="nav-item" data-page="vault">
                    <i class="fas fa-vault nav-icon"></i>
                    <span>Vault</span>
                    <div class="badge" id="vaultBadge">0</div>
                </a>
                <a href="#" class="nav-item" data-page="profile">
                    <i class="fas fa-user nav-icon"></i>
                    <span>Profile</span>
                </a>
            </nav>
        </div>
        
        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">
            <!-- Home Page (Default) -->
            <div id="homePage" class="page">
                <h1 class="page-title"><i class="fas fa-fire"></i> Trending Files</h1>
                
                <div class="tabs">
                    <div class="tab active" data-tab="all">All</div>
                    <div class="tab" data-tab="free">Free</div>
                    <div class="tab" data-tab="paid">Paid</div>
                </div>
                
                <div class="files-grid" id="filesGrid">
                    <!-- File cards will be dynamically inserted from Firebase -->
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon">
                            <i class="fas fa-folder-open"></i>
                        </div>
                        <h3>No files available</h3>
                        <p>Files will appear here once added by admin</p>
                    </div>
                </div>
            </div>
            
            <!-- Vault Page -->
            <div id="vaultPage" class="page" style="display: none;">
                <h1 class="page-title"><i class="fas fa-vault"></i> My Vault</h1>
                
                <div class="vault-container" id="vaultContainer">
                    <!-- Notifications will be dynamically inserted from Firebase -->
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-inbox"></i>
                        </div>
                        <h3>No notifications</h3>
                        <p>Your vault is empty. Purchase a file to see it here.</p>
                    </div>
                </div>
            </div>
            
            <!-- Profile Page -->
            <div id="profilePage" class="page" style="display: none;">
                <div class="profile-container">
                    <div class="profile-avatar" id="profileAvatar">U</div>
                    <h1 class="profile-name" id="profileName">User Name</h1>
                    <p class="profile-email" id="profileEmail">user@example.com</p>
                    
                    <div class="profile-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalPurchases">0</div>
                            <div class="stat-label">Purchases</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalSpent">৳0</div>
                            <div class="stat-label">Total Spent</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" style="width: 200px; margin-bottom: 1rem;" id="refreshProfileBtn">
                        <i class="fas fa-sync-alt"></i> Refresh Profile
                    </button>
                    <button class="btn btn-secondary" style="width: 200px;" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Login Modal (NO CLOSE BUTTON - User MUST login) -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <div class="modal-header" style="border-bottom: none; padding-bottom: 0;">
                <h2 class="modal-title">Welcome to Code Store BD</h2>
                <!-- NO CLOSE BUTTON - User cannot close modal without login -->
            </div>
            <div class="modal-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-auth="login">Login</div>
                    <div class="auth-tab" data-auth="register">Register</div>
                </div>
                
                <!-- Login Form -->
                <form class="auth-form active" id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="loginEmail">Email</label>
                        <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">Password</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <div class="modal-footer" style="border-top: none; padding-top: 0;">
                        <button type="submit" class="btn btn-primary">Login</button>
                    </div>
                </form>
                
                <!-- Register Form -->
                <form class="auth-form" id="registerForm">
                    <div class="form-group">
                        <label class="form-label" for="registerName">Full Name</label>
                        <input type="text" class="form-input" id="registerName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerPhone">Phone Number</label>
                        <input type="tel" class="form-input" id="registerPhone" placeholder="Enter your phone number" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerEmail">Email</label>
                        <input type="email" class="form-input" id="registerEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerPassword">Password (min 6 characters)</label>
                        <input type="password" class="form-input" id="registerPassword" placeholder="Create a password" required>
                    </div>
                    <div class="modal-footer" style="border-top: none; padding-top: 0;">
                        <button type="submit" class="btn btn-primary">Create Account</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- File Details Modal -->
    <div class="modal-overlay" id="fileDetailsModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="fileModalTitle">File Details</h2>
                <button class="modal-close" id="closeFileModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="fileModalContent">
                    <!-- File details will be dynamically inserted from Firebase -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Complete Purchase</h2>
                <button class="modal-close" id="closePaymentModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="payment-details">
                    <div class="payment-item">
                        <span class="payment-label">Product:</span>
                        <span class="payment-value" id="paymentProduct">Product Name</span>
                    </div>
                    <div class="payment-item">
                        <span class="payment-label">Price:</span>
                        <span class="payment-value" id="paymentPrice">৳0</span>
                    </div>
                </div>
                
                <p style="margin-bottom: 1.5rem;">Send payment to the following bKash number:</p>
                
                <div class="bkash-number">
                    <span id="bkashNumber">01XXXXXXXXX</span>
                    <button class="btn-copy" id="copyBkashBtn">Copy</button>
                </div>
                
                <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                    After sending money, enter the Transaction ID (TRX ID) below:
                </p>
                
                <div class="form-group">
                    <label class="form-label" for="trxId">Transaction ID (TRX ID)</label>
                    <input type="text" class="form-input" id="trxId" placeholder="Enter your bKash TRX ID" required>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelPaymentBtn">Cancel</button>
                    <button class="btn btn-success" id="submitPaymentBtn">Submit Payment</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Success Modal -->
    <div class="modal-overlay" id="paymentSuccessModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Payment Submitted!</h2>
                <button class="modal-close" id="closeSuccessModal">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 2rem 1rem;">
                    <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success); margin-bottom: 1.5rem;"></i>
                    <h3 style="margin-bottom: 1rem;">Payment Submitted Successfully</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                        Your payment of <strong id="successAmount">৳0</strong> for <strong id="successProduct">Product Name</strong> has been submitted for review.
                    </p>
                    <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                        <i class="fas fa-clock"></i> Admin processing time: <strong>Under 24 hours</strong>
                    </p>
                    <p style="color: var(--warning);">
                        <i class="fas fa-info-circle"></i> You can check the status in your <strong>Vault</strong> section.
                    </p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="goToVaultBtn">Go to Vault</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration - UPDATE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
  apiKey: "AIzaSyArwHqyI9Om48iChEeGBVPRxHLz2sKLAoU",
  authDomain: "code-store-bd.firebaseapp.com",
  projectId: "code-store-bd",
  storageBucket: "code-store-bd.firebasestorage.app",
  messagingSenderId: "935626127018",
  appId: "1:935626127018:web:f86d9065246bf7ed4a82d3",
  measurementId: "G-MDJSF653QY"
};
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>
    
    <script>
        // Global variables
        let currentUser = null;
        let currentFile = null;
        let files = [];
        let notifications = [];
        let payments = [];
        
        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const forcedLoginOverlay = document.getElementById('forcedLoginOverlay');
        const appContainer = document.querySelector('.app-container');
        const loginModal = document.getElementById('loginModal');
        const fileDetailsModal = document.getElementById('fileDetailsModal');
        const paymentModal = document.getElementById('paymentModal');
        const paymentSuccessModal = document.getElementById('paymentSuccessModal');
        const mainContent = document.getElementById('mainContent');
        const filesGrid = document.getElementById('filesGrid');
        const vaultContainer = document.getElementById('vaultContainer');
        const vaultBadge = document.getElementById('vaultBadge');
        const userAvatar = document.getElementById('userAvatar');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const totalPurchases = document.getElementById('totalPurchases');
        const totalSpent = document.getElementById('totalSpent');
        const logoutBtn = document.getElementById('logoutBtn');
        const refreshProfileBtn = document.getElementById('refreshProfileBtn');
        const showLoginFromForced = document.getElementById('showLoginFromForced');
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Simulate loading for 3 seconds
            setTimeout(() => {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    appContainer.style.display = 'grid';
                    
                    // Check authentication with Firebase
                    checkAuth();
                }, 500);
            }, 3000);
            
            // Setup event listeners
            setupEventListeners();
        });
        
        // Check authentication status with Firebase
        function checkAuth() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    
                    // Hide forced login overlay and login modal
                    forcedLoginOverlay.style.display = 'none';
                    loginModal.style.display = 'none';
                    
                    // Load user data from Firestore
                    loadUserData(user.uid);
                    
                    // Update UI for logged in user
                    updateUIForUser();
                    
                    // Load files and notifications
                    loadFiles();
                    loadNotifications();
                    loadPayments();
                    
                    // Setup real-time listeners
                    setupRealTimeListeners();
                } else {
                    // No user is signed in
                    // Show login modal (user cannot close it)
                    loginModal.style.display = 'flex';
                    
                    // Show forced login overlay (blocks all app functionality)
                    forcedLoginOverlay.style.display = 'flex';
                    
                    // Clear all data
                    files = [];
                    notifications = [];
                    payments = [];
                    currentUser = null;
                    
                    // Show empty state
                    filesGrid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <div class="empty-icon">
                                <i class="fas fa-sign-in-alt"></i>
                            </div>
                            <h3>Login Required</h3>
                            <p>Please login to browse files</p>
                        </div>
                    `;
                    
                    // Disable GET buttons
                    document.querySelectorAll('.btn-get').forEach(btn => {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                    });
                }
            });
        }
        
        // Force login check for protected actions
        function requireLogin(actionName) {
            if (!currentUser) {
                alert(`Please login to ${actionName}`);
                loginModal.style.display = 'flex';
                forcedLoginOverlay.style.display = 'flex';
                return false;
            }
            return true;
        }
        
        // Load user data from Firestore
        function loadUserData(userId) {
            db.collection('users').doc(userId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        currentUser = {
                            ...currentUser,
                            ...userData
                        };
                        updateProfileUI();
                    } else {
                        // User document doesn't exist, create it
                        createUserDocument(userId);
                    }
                })
                .catch((error) => {
                    console.error("Error loading user data:", error);
                });
        }
        
        // Create user document in Firestore
        function createUserDocument(userId) {
            const userData = {
                uid: userId,
                email: currentUser.email,
                name: currentUser.displayName || currentUser.email.split('@')[0],
                phone: '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                purchaseCount: 0,
                totalSpent: 0
            };
            
            db.collection('users').doc(userId).set(userData)
                .then(() => {
                    console.log("User document created successfully");
                    currentUser = {
                        ...currentUser,
                        ...userData
                    };
                    updateProfileUI();
                })
                .catch((error) => {
                    console.error("Error creating user document:", error);
                });
        }
        
        // Load files from Firestore
        function loadFiles() {
            db.collection('files').where('status', '==', 'active').get()
                .then((querySnapshot) => {
                    files = [];
                    querySnapshot.forEach((doc) => {
                        const fileData = doc.data();
                        fileData.id = doc.id;
                        files.push(fileData);
                    });
                    
                    renderFiles('all');
                })
                .catch((error) => {
                    console.error("Error loading files:", error);
                });
        }
        
        // Load notifications from Firestore
        function loadNotifications() {
            if (!currentUser) return;
            
            db.collection('notifications')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    notifications = [];
                    querySnapshot.forEach((doc) => {
                        const notificationData = doc.data();
                        notificationData.id = doc.id;
                        notifications.push(notificationData);
                    });
                    
                    // Update badge count (unread notifications)
                    const unreadCount = notifications.filter(n => !n.read).length;
                    vaultBadge.textContent = unreadCount;
                    
                    // Render if on vault page
                    if (document.getElementById('vaultPage').style.display === 'block') {
                        renderVault();
                    }
                })
                .catch((error) => {
                    console.error("Error loading notifications:", error);
                });
        }
        
        // Load payments from Firestore
        function loadPayments() {
            if (!currentUser) return;
            
            db.collection('payments')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    payments = [];
                    querySnapshot.forEach((doc) => {
                        const paymentData = doc.data();
                        paymentData.id = doc.id;
                        payments.push(paymentData);
                    });
                    
                    // Update profile stats
                    updateProfileStats();
                })
                .catch((error) => {
                    console.error("Error loading payments:", error);
                });
        }
        
        // Update profile statistics
        function updateProfileStats() {
            if (!currentUser) return;
            
            // Count approved purchases
            const approvedPayments = payments.filter(p => p.status === 'approved');
            const totalSpentAmount = approvedPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
            
            totalPurchases.textContent = approvedPayments.length;
            totalSpent.textContent = `৳${totalSpentAmount}`;
            
            // Update user document with latest stats
            db.collection('users').doc(currentUser.uid).update({
                purchaseCount: approvedPayments.length,
                totalSpent: totalSpentAmount
            });
        }
        
        // Setup all event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Check if user is logged in for protected pages
                    const page = this.getAttribute('data-page');
                    
                    if ((page === 'vault' || page === 'profile') && !currentUser) {
                        loginModal.style.display = 'flex';
                        forcedLoginOverlay.style.display = 'flex';
                        return;
                    }
                    
                    navigateTo(page);
                    
                    // Update active nav item
                    document.querySelectorAll('.nav-item').forEach(nav => {
                        nav.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
            
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabType = this.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Filter files
                    filterFiles(tabType);
                });
            });
            
            // Auth tab switching
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const authType = this.getAttribute('data-auth');
                    
                    // Update active auth tab
                    document.querySelectorAll('.auth-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Show corresponding form
                    document.querySelectorAll('.auth-form').forEach(form => {
                        form.classList.remove('active');
                    });
                    document.getElementById(authType + 'Form').classList.add('active');
                });
            });
            
            // Modal close buttons (except login modal - no close button there)
            document.getElementById('closeFileModal').addEventListener('click', () => {
                fileDetailsModal.style.display = 'none';
            });
            
            document.getElementById('closePaymentModal').addEventListener('click', () => {
                paymentModal.style.display = 'none';
            });
            
            document.getElementById('closeSuccessModal').addEventListener('click', () => {
                paymentSuccessModal.style.display = 'none';
            });
            
            // Show login from forced overlay
            showLoginFromForced.addEventListener('click', () => {
                forcedLoginOverlay.style.display = 'none';
                loginModal.style.display = 'flex';
            });
            
            // User avatar click
            userAvatar.addEventListener('click', () => {
                if (!currentUser) {
                    loginModal.style.display = 'flex';
                    forcedLoginOverlay.style.display = 'flex';
                    return;
                }
                
                navigateTo('profile');
                
                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });
                document.querySelector('.nav-item[data-page="profile"]').classList.add('active');
            });
            
            // Login form submission
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                // Firebase authentication
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Signed in successfully
                        loginModal.style.display = 'none';
                        forcedLoginOverlay.style.display = 'none';
                        console.log("User logged in:", userCredential.user);
                        
                        // Clear form
                        document.getElementById('loginEmail').value = '';
                        document.getElementById('loginPassword').value = '';
                    })
                    .catch((error) => {
                        console.error("Login error:", error);
                        alert("Login failed: " + error.message);
                    });
            });
            
            // Register form submission
            document.getElementById('registerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('registerName').value;
                const phone = document.getElementById('registerPhone').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                
                if (password.length < 6) {
                    alert('Password must be at least 6 characters');
                    return;
                }
                
                // Firebase authentication
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // User created successfully
                        const user = userCredential.user;
                        
                        // Update user profile
                        user.updateProfile({
                            displayName: name
                        });
                        
                        // Create user document in Firestore
                        const userData = {
                            uid: user.uid,
                            email: email,
                            name: name,
                            phone: phone,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            purchaseCount: 0,
                            totalSpent: 0
                        };
                        
                        return db.collection('users').doc(user.uid).set(userData);
                    })
                    .then(() => {
                        // Close modal
                        loginModal.style.display = 'none';
                        forcedLoginOverlay.style.display = 'none';
                        console.log("User registered successfully");
                        
                        // Clear form
                        document.getElementById('registerName').value = '';
                        document.getElementById('registerPhone').value = '';
                        document.getElementById('registerEmail').value = '';
                        document.getElementById('registerPassword').value = '';
                    })
                    .catch((error) => {
                        console.error("Registration error:", error);
                        alert("Registration failed: " + error.message);
                    });
            });
            
            // Payment modal buttons
            document.getElementById('copyBkashBtn').addEventListener('click', function() {
                const bkashNumber = document.getElementById('bkashNumber').textContent;
                navigator.clipboard.writeText(bkashNumber).then(() => {
                    this.textContent = 'Copied!';
                    setTimeout(() => {
                        this.textContent = 'Copy';
                    }, 2000);
                });
            });
            
            document.getElementById('cancelPaymentBtn').addEventListener('click', () => {
                paymentModal.style.display = 'none';
            });
            
            document.getElementById('submitPaymentBtn').addEventListener('click', function() {
                if (!requireLogin('make a purchase')) return;
                
                const trxId = document.getElementById('trxId').value;
                if (!trxId) {
                    alert('Please enter your Transaction ID');
                    return;
                }
                
                // Submit payment to Firestore
                submitPayment(trxId);
            });
            
            // Success modal buttons
            document.getElementById('goToVaultBtn').addEventListener('click', () => {
                paymentSuccessModal.style.display = 'none';
                navigateTo('vault');
                
                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });
                document.querySelector('.nav-item[data-page="vault"]').classList.add('active');
            });
            
            // Refresh profile button
            refreshProfileBtn.addEventListener('click', () => {
                if (!requireLogin('refresh profile')) return;
                
                loadPayments();
                loadUserData(currentUser.uid);
                alert('Profile refreshed!');
            });
            
            // Logout button
            logoutBtn.addEventListener('click', () => {
                auth.signOut()
                    .then(() => {
                        console.log("User signed out");
                        currentUser = null;
                        
                        // Show login modal (user cannot close it)
                        loginModal.style.display = 'flex';
                        forcedLoginOverlay.style.display = 'flex';
                        
                        navigateTo('home');
                        
                        // Update nav
                        document.querySelectorAll('.nav-item').forEach(nav => {
                            nav.classList.remove('active');
                        });
                        document.querySelector('.nav-item[data-page="home"]').classList.add('active');
                    })
                    .catch((error) => {
                        console.error("Logout error:", error);
                    });
            });
            
            // Close other modals when clicking outside (but NOT login modal)
            window.addEventListener('click', function(e) {
                if (e.target === fileDetailsModal) {
                    fileDetailsModal.style.display = 'none';
                }
                if (e.target === paymentModal) {
                    paymentModal.style.display = 'none';
                }
                if (e.target === paymentSuccessModal) {
                    paymentSuccessModal.style.display = 'none';
                }
                // NOTE: loginModal cannot be closed by clicking outside
            });
        }
        
        // Navigation function
        function navigateTo(page) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => {
                p.style.display = 'none';
            });
            
            // Show selected page
            document.getElementById(page + 'Page').style.display = 'block';
            
            // Load data for the page
            if (page === 'home') {
                renderFiles('all');
            } else if (page === 'vault') {
                if (!currentUser) {
                    loginModal.style.display = 'flex';
                    forcedLoginOverlay.style.display = 'flex';
                    return;
                }
                renderVault();
                // Mark notifications as read when vault is viewed
                markNotificationsAsRead();
            } else if (page === 'profile') {
                if (!currentUser) {
                    loginModal.style.display = 'flex';
                    forcedLoginOverlay.style.display = 'flex';
                    return;
                }
                updateProfileUI();
            }
        }
        
        // Mark notifications as read
        function markNotificationsAsRead() {
            if (!currentUser) return;
            
            // Update all unread notifications
            const unreadNotifications = notifications.filter(n => !n.read);
            
            unreadNotifications.forEach(notification => {
                db.collection('notifications').doc(notification.id).update({
                    read: true,
                    readAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            
            // Clear badge
            vaultBadge.textContent = '0';
        }
        
        // Render files to the grid
        function renderFiles(filter = 'all') {
            filesGrid.innerHTML = '';
            
            let filteredFiles = files;
            if (filter === 'free') {
                filteredFiles = files.filter(file => file.price === 0 || file.price === '0');
            } else if (filter === 'paid') {
                filteredFiles = files.filter(file => file.price > 0);
            }
            
            if (filteredFiles.length === 0) {
                filesGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon">
                            <i class="fas fa-folder-open"></i>
                        </div>
                        <h3>No files found</h3>
                        <p>Try a different filter or check back later</p>
                    </div>
                `;
                return;
            }
            
            filteredFiles.forEach((file, index) => {
                const fileCard = document.createElement('div');
                fileCard.className = 'file-card';
                fileCard.style.animationDelay = `${index * 0.1}s`;
                
                fileCard.innerHTML = `
                    <div class="file-banner" style="${file.banner ? `background-image: url('${file.banner}');` : ''}">
                        ${!file.banner ? `<i class="fas fa-file-code"></i>` : ''}
                    </div>
                    <div class="file-content">
                        <h3 class="file-title">${file.title || 'Untitled File'}</h3>
                        <p class="file-description">${file.description || 'No description available'}</p>
                        <div class="file-footer">
                            <div class="file-price ${file.price === 0 || file.price === '0' ? 'price-free' : 'price-paid'}">
                                ${file.price === 0 || file.price === '0' ? 'FREE' : `৳${file.price}`}
                            </div>
                            <button class="btn-get" data-file-id="${file.id}">GET</button>
                        </div>
                    </div>
                `;
                
                filesGrid.appendChild(fileCard);
            });
            
            // Add event listeners to GET buttons
            document.querySelectorAll('.btn-get').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!currentUser) {
                        loginModal.style.display = 'flex';
                        forcedLoginOverlay.style.display = 'flex';
                        return;
                    }
                    
                    const fileId = this.getAttribute('data-file-id');
                    const file = files.find(f => f.id === fileId);
                    if (file) {
                        showFileDetails(file);
                    }
                });
            });
        }
        
        // Filter files based on tab
        function filterFiles(filter) {
            renderFiles(filter);
        }
        
        // Show file details modal
        function showFileDetails(file) {
            if (!currentUser) {
                loginModal.style.display = 'flex';
                forcedLoginOverlay.style.display = 'flex';
                return;
            }
            
            currentFile = file;
            
            const modalTitle = document.getElementById('fileModalTitle');
            const modalContent = document.getElementById('fileModalContent');
            
            modalTitle.textContent = file.title || 'File Details';
            
            const price = file.price || 0;
            const isFree = price === 0 || price === '0';
            
            if (isFree) {
                // Free file
                modalContent.innerHTML = `
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div class="file-banner" style="border-radius: 12px; margin-bottom: 1.5rem; ${file.banner ? `background-image: url('${file.banner}');` : ''}">
                            ${!file.banner ? `<i class="fas fa-file-code"></i>` : ''}
                        </div>
                        <h3 style="margin-bottom: 0.5rem;">${file.title || 'Untitled File'}</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">${file.description || 'No description available'}</p>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent); margin-bottom: 1.5rem;">
                            FREE
                        </div>
                    </div>
                    <div class="modal-footer" style="border-top: none; padding-top: 0;">
                        <button class="btn btn-primary" id="downloadFreeBtn" style="width: 100%;">
                            <i class="fas fa-download"></i> DOWNLOAD NOW
                        </button>
                    </div>
                `;
                
                // Add event listener to download button
                setTimeout(() => {
                    document.getElementById('downloadFreeBtn').addEventListener('click', () => {
                        if (!requireLogin('download file')) return;
                        downloadFile(file);
                        fileDetailsModal.style.display = 'none';
                    });
                }, 100);
            } else {
                // Paid file
                modalContent.innerHTML = `
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div class="file-banner" style="border-radius: 12px; margin-bottom: 1.5rem; ${file.banner ? `background-image: url('${file.banner}');` : ''}">
                            ${!file.banner ? `<i class="fas fa-file-code"></i>` : ''}
                        </div>
                        <h3 style="margin-bottom: 0.5rem;">${file.title || 'Untitled File'}</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">${file.description || 'No description available'}</p>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--secondary); margin-bottom: 1.5rem;">
                            ৳${price}
                        </div>
                    </div>
                    <div class="modal-footer" style="border-top: none; padding-top: 0;">
                        <button class="btn btn-primary" id="buyFileBtn" style="width: 100%;">
                            <i class="fas fa-shopping-cart"></i> BUY NOW - ৳${price}
                        </button>
                    </div>
                `;
                
                // Add event listener to buy button
                setTimeout(() => {
                    document.getElementById('buyFileBtn').addEventListener('click', () => {
                        if (!requireLogin('purchase file')) return;
                        fileDetailsModal.style.display = 'none';
                        showPaymentModal(file);
                    });
                }, 100);
            }
            
            fileDetailsModal.style.display = 'flex';
        }
        
        // Show payment modal
        function showPaymentModal(file) {
            if (!currentUser) {
                loginModal.style.display = 'flex';
                forcedLoginOverlay.style.display = 'flex';
                return;
            }
            
            document.getElementById('paymentProduct').textContent = file.title || 'Product';
            document.getElementById('paymentPrice').textContent = `৳${file.price || 0}`;
            document.getElementById('bkashNumber').textContent = file.bkashNumber || '01XXXXXXXXX';
            document.getElementById('successAmount').textContent = `৳${file.price || 0}`;
            document.getElementById('successProduct').textContent = file.title || 'Product';
            
            // Reset TRX ID field
            document.getElementById('trxId').value = '';
            
            paymentModal.style.display = 'flex';
        }
        
        // Submit payment to Firestore
        function submitPayment(trxId) {
            if (!currentUser || !currentFile) return;
            
            const paymentData = {
                userId: currentUser.uid,
                userEmail: currentUser.email,
                userName: currentUser.name || currentUser.email,
                fileId: currentFile.id,
                fileTitle: currentFile.title || 'Untitled File',
                amount: parseInt(currentFile.price) || 0,
                bkashNumber: currentFile.bkashNumber || '01XXXXXXXXX',
                transactionId: trxId,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Add payment to Firestore
            db.collection('payments').add(paymentData)
                .then((docRef) => {
                    console.log("Payment submitted with ID: ", docRef.id);
                    
                    // Create notification for user
                    const notificationData = {
                        userId: currentUser.uid,
                        type: 'payment',
                        status: 'pending',
                        title: 'Payment Submitted',
                        message: `Your payment of ৳${currentFile.price} for '${currentFile.title}' has been submitted for review`,
                        paymentId: docRef.id,
                        fileId: currentFile.id,
                        fileTitle: currentFile.title,
                        fileBanner: currentFile.banner,
                        fileDescription: currentFile.description,
                        read: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    return db.collection('notifications').add(notificationData);
                })
                .then(() => {
                    // Update vault badge
                    const currentBadge = parseInt(vaultBadge.textContent);
                    vaultBadge.textContent = currentBadge + 1;
                    
                    // Close payment modal and show success
                    paymentModal.style.display = 'none';
                    paymentSuccessModal.style.display = 'flex';
                    
                    // Reload notifications
                    loadNotifications();
                })
                .catch((error) => {
                    console.error("Error submitting payment: ", error);
                    alert("Payment submission failed: " + error.message);
                });
        }
        
        // Download file
        function downloadFile(file) {
            if (!currentUser) {
                loginModal.style.display = 'flex';
                forcedLoginOverlay.style.display = 'flex';
                return;
            }
            
            if (file.downloadUrl) {
                // Open download URL in new tab
                window.open(file.downloadUrl, '_blank');
            } else {
                alert('Download link not available');
            }
        }
        
        // Render vault notifications
        function renderVault() {
            vaultContainer.innerHTML = '';
            
            if (notifications.length === 0) {
                vaultContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-inbox"></i>
                        </div>
                        <h3>No notifications</h3>
                        <p>Your vault is empty. Purchase a file to see it here.</p>
                    </div>
                `;
                return;
            }
            
            notifications.forEach((notification, index) => {
                const notifCard = document.createElement('div');
                notifCard.className = `notification-card ${notification.status}`;
                notifCard.style.animationDelay = `${index * 0.1}s`;
                
                let fileSection = '';
                let actionButton = '';
                
                if (notification.fileId) {
                    fileSection = `
                        <div class="notification-file">
                            <div class="file-preview">
                                <div class="file-preview-img" style="${notification.fileBanner ? `background-image: url('${notification.fileBanner}');` : ''}">
                                    ${!notification.fileBanner ? `<i class="fas fa-file-code"></i>` : ''}
                                </div>
                                <div class="file-preview-info">
                                    <h4>${notification.fileTitle || 'File'}</h4>
                                    <p>${notification.fileDescription || 'No description'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (notification.status === 'approved') {
                        actionButton = `<button class="btn btn-success" style="width: 100%;" data-file-id="${notification.fileId}"><i class="fas fa-download"></i> Download File</button>`;
                    }
                }
                
                let reasonSection = '';
                if (notification.status === 'rejected' && notification.reason) {
                    reasonSection = `<p style="color: var(--danger); margin-top: 1rem;"><strong>Reason:</strong> ${notification.reason}</p>`;
                }
                
                // Format timestamp
                let timestamp = 'Recently';
                if (notification.createdAt && notification.createdAt.toDate) {
                    const date = notification.createdAt.toDate();
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    if (diffMins < 60) {
                        timestamp = `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
                    } else if (diffHours < 24) {
                        timestamp = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
                    } else {
                        timestamp = `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
                    }
                }
                
                notifCard.innerHTML = `
                    <div class="notification-header">
                        <div class="notification-status">${notification.title || notification.status}</div>
                        <div class="notification-time">${timestamp}</div>
                    </div>
                    <div class="notification-message">${notification.message || ''}</div>
                    ${fileSection}
                    ${reasonSection}
                    ${actionButton}
                `;
                
                vaultContainer.appendChild(notifCard);
            });
            
            // Add event listeners to download buttons
            setTimeout(() => {
                document.querySelectorAll('.btn-success[data-file-id]').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (!requireLogin('download file')) return;
                        const fileId = this.getAttribute('data-file-id');
                        // Find the file to download
                        // In a real app, you would fetch the download URL from the payment/notification
                        alert('Download functionality would fetch the file URL from Firebase');
                    });
                });
            }, 100);
        }
        
        // Update profile UI
        function updateProfileUI() {
            if (!currentUser) return;
            
            const firstName = currentUser.name ? currentUser.name.split(' ')[0] : currentUser.email.split('@')[0];
            const firstLetter = firstName.charAt(0).toUpperCase();
            
            profileAvatar.textContent = firstLetter;
            profileName.textContent = currentUser.name || currentUser.email.split('@')[0];
            profileEmail.textContent = currentUser.email;
            userAvatar.textContent = firstLetter;
        }
        
        // Update UI after login
        function updateUIForUser() {
            updateProfileUI();
            renderFiles('all');
            navigateTo('home');
        }
        
        // Real-time listeners for Firestore updates
        function setupRealTimeListeners() {
            if (!currentUser) return;
            
            // Listen for file updates
            db.collection('files').where('status', '==', 'active')
                .onSnapshot((snapshot) => {
                    files = [];
                    snapshot.forEach((doc) => {
                        const fileData = doc.data();
                        fileData.id = doc.id;
                        files.push(fileData);
                    });
                    
                    // Update files if on home page
                    if (document.getElementById('homePage').style.display === 'block') {
                        const activeTab = document.querySelector('.tab.active');
                        const filter = activeTab ? activeTab.getAttribute('data-tab') : 'all';
                        renderFiles(filter);
                    }
                });
            
            // Listen for notification updates
            db.collection('notifications')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    notifications = [];
                    snapshot.forEach((doc) => {
                        const notificationData = doc.data();
                        notificationData.id = doc.id;
                        notifications.push(notificationData);
                    });
                    
                    // Update badge count
                    const unreadCount = notifications.filter(n => !n.read).length;
                    vaultBadge.textContent = unreadCount;
                    
                    // Update vault if on vault page
                    if (document.getElementById('vaultPage').style.display === 'block') {
                        renderVault();
                    }
                });
            
            // Listen for payment updates
            db.collection('payments')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    payments = [];
                    snapshot.forEach((doc) => {
                        const paymentData = doc.data();
                        paymentData.id = doc.id;
                        payments.push(paymentData);
                    });
                    
                    // Update profile stats
                    updateProfileStats();
                });
        }
        
        // Initialize with home page
        setTimeout(() => {
            if (currentUser) {
                navigateTo('home');
                setupRealTimeListeners();
            }
        }, 500);
    </script>
</body>
</html>